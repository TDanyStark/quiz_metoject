---
import { URL_BASE } from "@/config";
import { quizData } from "@/data";
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <div
    class="relative flex min-h-screen flex-col"
    style={`background-image: url('${URL_BASE}/imgs/bg-main.webp'); background-size: cover; background-position: center;`}
  >
    <div class="absolute top-0 left-0 w-full overflow-hidden">
      <img
        class="max-w-60 lg:max-w-3xl"
        src={`${URL_BASE}/imgs/svg/header hero.svg`}
        alt="Encabezado"
      />
    </div>

    <header class="flex justify-end p-4">
      <img
        class="w-36 md:w-40"
        src={`${URL_BASE}/imgs/svg/logo_metoject.svg`}
        alt="Logo metoject"
      />
    </header>

    <main class="flex flex-1 items-center justify-center p-4 md:p-6">
      <section
        id="quiz-app"
        class="w-full max-w-6xl rounded-2xl border border-blue-light-metoject/30 bg-white/80 p-4 shadow-xl backdrop-blur-sm md:p-6"
        data-url-base={URL_BASE}
      >
        <div id="selector-view" class="space-y-6">
          <h1
            class="text-center font-raleway text-3xl font-black text-blue-dark-metoject md:text-4xl"
          >
            CASOS CLÍNICOS
          </h1>
          <p class="text-center font-raleway text-blue-dark-metoject/80">
            Selecciona un paciente para resolver su caso clínico.
          </p>
          <div
            id="patients-grid"
            class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4"
          >
          </div>
        </div>

        <div id="case-view" class="hidden space-y-4">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <button
              id="back-to-patients"
              type="button"
              class="rounded-lg bg-blue-dark-metoject px-4 py-2 font-raleway text-sm font-bold text-white transition hover:opacity-90"
            >
              Cambiar paciente
            </button>
            <div class="flex items-center gap-3">
              <img
                id="case-badge"
                class="h-12 w-auto"
                alt="Insignia del caso"
              />
              <h2
                id="case-title"
                class="font-raleway text-2xl font-black text-blue-dark-metoject"
              >
              </h2>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-4 lg:grid-cols-[1fr_400px]">
            <article class="relative rounded-2xl bg-white p-5 shadow-lg">
              <p
                id="case-description"
                class="mb-4 font-raleway text-sm leading-relaxed text-slate-700 md:text-base"
              >
              </p>
              <h3
                id="case-question"
                class="mb-4 font-raleway text-lg font-bold text-blue-dark-metoject"
              >
              </h3>

              <ul id="options-list" class="space-y-3"></ul>

              <div
                id="feedback-popup"
                class="pointer-events-none absolute inset-x-5 top-22 z-20 hidden rounded-xl border-2 bg-white p-4 shadow-2xl"
                role="status"
                aria-live="polite"
              >
                <p
                  id="feedback-text"
                  class="font-raleway text-sm font-bold md:text-base"
                >
                </p>
              </div>

              <div class="mt-5 border-t border-slate-200 pt-4">
                <h4
                  class="mb-2 font-raleway text-sm font-bold text-blue-dark-metoject"
                >
                  Referencias
                </h4>
                <ol
                  id="references-list"
                  class="list-decimal space-y-1 pl-5 font-raleway text-xs text-slate-600 md:text-sm"
                >
                </ol>
              </div>
            </article>

            <aside
              class="flex flex-col justify-end rounded-2xl bg-linear-to-b from-blue-light-metoject/20 to-blue-dark-metoject/10 p-3"
            >
              <img
                id="patient-image"
                class="mx-auto h-auto w-full max-w-96"
                alt="Paciente"
              />
              <div
                class="rounded-xl bg-blue-dark-metoject p-3 text-center text-white"
              >
                <p class="font-raleway text-2xl font-black" id="patient-name">
                </p>
                <p class="font-raleway text-base" id="patient-age"></p>
              </div>
            </aside>
          </div>
        </div>
      </section>
    </main>

    <footer class="flex items-end justify-between gap-4">
      <img
        class="block h-auto w-96 max-w-full lg:w-xl"
        src={`${URL_BASE}/imgs/svg/footer 1.svg`}
        alt="Footer 1"
      />
      <img
        class="hidden h-auto w-96 lg:block"
        src={`${URL_BASE}/imgs/svg/footer 2.svg`}
        alt="Footer 2"
      />
    </footer>
  </div>

  <script is:inline define:vars={{ quizData }}>
    (() => {
      const app = document.getElementById("quiz-app");
      if (!app) return;

      const cases = Array.isArray(quizData?.cases) ? quizData.cases : [];
      const urlBase = app.dataset.urlBase || "";

      const selectorView = document.getElementById("selector-view");
      const caseView = document.getElementById("case-view");
      const patientsGrid = document.getElementById("patients-grid");
      const backToPatientsButton = document.getElementById("back-to-patients");

      const caseBadge = document.getElementById("case-badge");
      const caseTitle = document.getElementById("case-title");
      const caseDescription = document.getElementById("case-description");
      const caseQuestion = document.getElementById("case-question");
      const optionsList = document.getElementById("options-list");
      const referencesList = document.getElementById("references-list");

      const patientImage = document.getElementById("patient-image");
      const patientName = document.getElementById("patient-name");
      const patientAge = document.getElementById("patient-age");

      const feedbackPopup = document.getElementById("feedback-popup");
      const feedbackText = document.getElementById("feedback-text");

      let selectedCase = null;

      const escapeHTML = (value) =>
        String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");

      const hideFeedback = () => {
        if (!feedbackPopup || !feedbackText) return;
        feedbackPopup.classList.add("hidden");
        feedbackPopup.classList.remove("border-green-500", "border-red-500");
        feedbackText.classList.remove("text-green-700", "text-red-700");
        feedbackText.textContent = "";
      };

      const showFeedback = (isCorrect, message) => {
        if (!feedbackPopup || !feedbackText) return;
        feedbackPopup.classList.remove("hidden");
        feedbackPopup.classList.toggle("border-green-500", isCorrect);
        feedbackPopup.classList.toggle("border-red-500", !isCorrect);
        feedbackText.classList.toggle("text-green-700", isCorrect);
        feedbackText.classList.toggle("text-red-700", !isCorrect);
        feedbackText.textContent = message;
      };

      const selectCase = (caseId) => {
        selectedCase = cases.find((item) => item.id === caseId) || null;
        if (!selectedCase) return;

        hideFeedback();

        if (caseTitle) caseTitle.textContent = selectedCase.title;
        if (caseDescription)
          caseDescription.textContent = selectedCase.description;
        if (caseQuestion) caseQuestion.textContent = selectedCase.question;

        if (caseBadge) {
          caseBadge.setAttribute(
            "src",
            `${urlBase}/imgs/insignias/${selectedCase.badgeUrl}`,
          );
          caseBadge.setAttribute("alt", `Insignia ${selectedCase.title}`);
        }

        if (patientImage) {
          patientImage.setAttribute(
            "src",
            `${urlBase}/imgs/pacientes/${selectedCase.imageUrl}`,
          );
          patientImage.setAttribute(
            "alt",
            `Imagen de ${selectedCase.patientName}`,
          );
        }

        if (patientName) patientName.textContent = selectedCase.patientName;
        if (patientAge) patientAge.textContent = `${selectedCase.age} años`;

        if (optionsList) {
          optionsList.innerHTML = selectedCase.options
            .map(
              (option, optionIndex) => `
								<li>
									<button
										type="button"
										data-option-index="${optionIndex}"
										class="quiz-option w-full rounded-xl border-2 border-blue-dark-metoject/20 bg-blue-light-metoject/10 p-3 text-left font-raleway text-sm text-slate-800 transition hover:border-blue-dark-metoject hover:bg-blue-light-metoject/20"
									>
										<span class="font-bold text-blue-dark-metoject">${String.fromCharCode(65 + optionIndex)}.</span>
										${escapeHTML(option)}
									</button>
								</li>
							`,
            )
            .join("");
        }

        if (referencesList) {
          referencesList.innerHTML = selectedCase.references
            .map((reference) => `<li>${escapeHTML(reference)}</li>`)
            .join("");
        }

        selectorView?.classList.add("hidden");
        caseView?.classList.remove("hidden");
      };

      const renderPatientSelector = () => {
        if (!patientsGrid) return;

        patientsGrid.innerHTML = cases
          .map(
            (item) => `
							<button
								type="button"
								data-case-id="${item.id}"
								class="group rounded-2xl border border-blue-light-metoject/50 bg-white p-3 text-left shadow transition hover:-translate-y-1 hover:shadow-lg"
							>
								<img
									src="${urlBase}/imgs/pacientes/${item.imageUrl}"
									alt="Paciente ${escapeHTML(item.patientName)}"
									class="mx-auto h-48 w-full object-contain"
								/>
								<div class="rounded-lg bg-blue-dark-metoject px-3 py-2 text-white">
									<p class="font-raleway text-lg font-black">${escapeHTML(item.patientName)}</p>
									<p class="font-raleway text-sm">${item.age} años</p>
								</div>
							</button>
						`,
          )
          .join("");
      };

      app.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;

        const caseButton = target.closest("[data-case-id]");
        if (caseButton instanceof HTMLElement) {
          const caseId = Number(caseButton.dataset.caseId);
          if (!Number.isNaN(caseId)) selectCase(caseId);
          return;
        }

        const optionButton = target.closest("[data-option-index]");
        if (optionButton instanceof HTMLElement && selectedCase) {
          const optionIndex = Number(optionButton.dataset.optionIndex);
          if (Number.isNaN(optionIndex)) return;

          const isCorrect = optionIndex === selectedCase.correctAnswer;
          const message = isCorrect
            ? selectedCase.correctFeedback
            : selectedCase.incorrectFeedback;
          showFeedback(isCorrect, message);

          if (isCorrect && optionsList) {
            optionsList.querySelectorAll(".quiz-option").forEach((button) => {
              if (button instanceof HTMLButtonElement) button.disabled = true;
            });
          }
        }
      });

      backToPatientsButton?.addEventListener("click", () => {
        hideFeedback();
        caseView?.classList.add("hidden");
        selectorView?.classList.remove("hidden");
      });

      renderPatientSelector();
    })();
  </script>
</Layout>
