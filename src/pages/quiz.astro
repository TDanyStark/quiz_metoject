---
import { URL_BASE } from "@/config";
import { quizData } from "@/data";
import Layout from "@/layouts/Layout.astro";
import Footer from "@/components/Footer.astro";
import Header from "@/components/Header.astro";
---

<Layout>
  <div
    class="relative flex min-h-screen flex-col"
    style={`background-image: url('${URL_BASE}/imgs/bg-main.webp'); background-size: cover; background-position: center;`}
  >
    <Header />

    <main class="flex flex-1 items-center justify-center p-4 md:p-6">
      <section
        id="quiz-app"
        class="w-full max-w-7xl rounded-2xl border border-blue-light-metoject/30 bg-white/80 p-4 shadow-xl backdrop-blur-sm md:p-6"
        data-url-base={URL_BASE}
        data-quiz-cases={JSON.stringify(quizData.cases)}
      >
        <div id="selector-view" class="space-y-2">
          <h1
            class="text-center font-raleway text-4xl font-black text-blue-dark-metoject md:text-5xl"
          >
            CASOS CLÍNICOS
          </h1>
          <p class="text-center font-raleway text-blue-dark-metoject/80 text-lg">
            Selecciona un paciente para resolver su caso clínico.
          </p>
          <div class="mt-4 flex justify-end">
            <button
              id="reset-progress-selector"
              data-action="reset-progress"
              type="button"
              class="rounded-lg bg-blue-dark-metoject px-4 py-2 font-raleway text-sm font-bold text-white transition hover:opacity-90"
            >
              Reiniciar progreso
            </button>
          </div>
          <div
            id="patients-grid"
            class="mt-10 grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-4"
          >
          </div>
        </div>

        <div id="case-view" class="hidden space-y-4">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="flex flex-wrap items-center gap-3">
              <button
                id="back-to-patients"
                type="button"
                class="rounded-lg bg-blue-dark-metoject px-4 py-2 font-raleway text-sm font-bold text-white transition hover:opacity-90"
              >
                Cambiar paciente
              </button>
              <button
                id="reset-progress-case"
                data-action="reset-progress"
                type="button"
                class="rounded-lg bg-blue-dark-metoject px-4 py-2 font-raleway text-sm font-bold text-white transition hover:opacity-90"
              >
                Reiniciar progreso
              </button>
            </div>
            <div class="flex items-center gap-3">
              <h2
                id="case-title"
                class="font-raleway text-2xl font-black text-blue-dark-metoject"
              >
              </h2>
              <img
                id="case-badge"
                class="h-20 lg:h-36 w-auto"
                alt="Insignia del caso"
              />
            </div>
          </div>

          <div class="grid grid-cols-1 gap-4 lg:grid-cols-[1fr_400px]">
            <article class="relative rounded-2xl bg-white p-5 shadow-lg">
              <p
                id="case-description"
                class="mb-4 font-raleway text-pretty leading-relaxed text-slate-700 md:text-lg"
              >
              </p>
              <h3
                id="case-question"
                class="mb-4 font-raleway text-pretty text-xl font-bold text-blue-dark-metoject"
              >
              </h3>

              <ul id="options-list" class="space-y-3"></ul>

              <div
                id="feedback-modal"
                class="fixed inset-0 z-50 hidden items-center justify-center"
                role="dialog"
                aria-modal="true"
                aria-live="polite"
              >
                <button
                  type="button"
                  id="feedback-overlay"
                  aria-label="Cerrar notificación"
                  class="absolute inset-0 bg-slate-900/35 rounded-2xl"
                ></button>

                <div
                  id="feedback-card"
                  class="relative mx-4 w-full max-w-3xl rounded-4xl border-2 p-7 md:p-10"
                >
                  <button
                    type="button"
                    id="feedback-close"
                    aria-label="Cerrar"
                    class="absolute right-4 top-4 flex h-9 w-9 items-center justify-center rounded-full border-2 border-current text-xl font-bold leading-none transition hover:opacity-90"
                  >
                    ×
                  </button>

                  <div class="mx-auto max-w-2xl text-center">
                    <img
                      id="feedback-icon"
                      class="mx-auto mb-3 h-16 w-16 md:h-20 md:w-20"
                      alt=""
                    />
                    <p
                      id="feedback-title"
                      class="mb-2 font-raleway text-4xl font-black leading-tight md:text-5xl"
                    >
                    </p>
                    <p
                      id="feedback-text"
                      class="font-raleway text-base font-bold leading-snug md:text-2xl"
                    >
                    </p>
                  </div>
                </div>
              </div>

              <div class="mt-5 border-t border-slate-200 pt-4">
                <h4
                  class="mb-2 font-raleway text-sm font-bold text-blue-dark-metoject"
                >
                  Referencias
                </h4>
                <ol
                  id="references-list"
                  class="list-decimal space-y-1 pl-5 font-raleway text-xs text-slate-600 md:text-sm"
                >
                </ol>
              </div>
            </article>

            <aside
              id="patient-aside"
              class="flex flex-col justify-end rounded-2xl bg-linear-to-b from-blue-light-metoject/20 to-blue-dark-metoject/10 p-3"
            >
              <img
                id="patient-image"
                class="mx-auto h-auto w-full max-w-96"
                alt="Paciente"
              />
              <div
                id="patient-info-card"
                class="rounded-xl bg-blue-dark-metoject p-3 text-center text-white"
              >
                <p class="font-raleway text-2xl font-black" id="patient-name">
                </p>
                <p class="font-raleway text-base" id="patient-age"></p>
              </div>
            </aside>
          </div>
        </div>
      </section>
    </main>

    <Footer/>
  </div>

  <script>
    // @ts-nocheck
    import confetti from "canvas-confetti";

    /**
     * @typedef {Object} QuizCase
     * @property {number} id
     * @property {string} patientName
     * @property {number} age
     * @property {string} imageUrl
     * @property {string} badgeUrl
     * @property {string} title
     * @property {string} description
     * @property {string} question
     * @property {string[]} options
     * @property {number} correctAnswer
     * @property {string} incorrectFeedback
     * @property {string} correctFeedback
     * @property {string[]} references
     */

    (() => {
      const app = document.getElementById("quiz-app");
      if (!(app instanceof HTMLElement)) return;

      /** @returns {QuizCase[]} */
      const parseCases = () => {
        try {
          const parsed = JSON.parse(app.dataset.quizCases || "[]");
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      };

      const cases = parseCases();
      const urlBase = app.dataset.urlBase || "";
      const progressStorageKey = "quiz-metoject-progress-v1";

      const selectorView = document.getElementById("selector-view");
      const caseView = document.getElementById("case-view");
      const patientsGrid = document.getElementById("patients-grid");
      const backToPatientsButton = document.getElementById("back-to-patients");

      const caseBadge = document.getElementById("case-badge");
      const caseTitle = document.getElementById("case-title");
      const caseDescription = document.getElementById("case-description");
      const caseQuestion = document.getElementById("case-question");
      const optionsList = document.getElementById("options-list");
      const referencesList = document.getElementById("references-list");

      const patientImage = document.getElementById("patient-image");
      const patientAside = document.getElementById("patient-aside");
      const patientInfoCard = document.getElementById("patient-info-card");
      const patientName = document.getElementById("patient-name");
      const patientAge = document.getElementById("patient-age");

      const feedbackModal = document.getElementById("feedback-modal");
      const feedbackOverlay = document.getElementById("feedback-overlay");
      const feedbackCard = document.getElementById("feedback-card");
      const feedbackClose = document.getElementById("feedback-close");
      const feedbackIcon = document.getElementById("feedback-icon");
      const feedbackTitle = document.getElementById("feedback-title");
      const feedbackText = document.getElementById("feedback-text");

      const validCaseIds = new Set(cases.map((item) => item.id));

      /** @returns {Set<number>} */
      const loadProgress = () => {
        try {
          const rawValue = window.localStorage.getItem(progressStorageKey);
          if (!rawValue) return new Set();
          const parsed = JSON.parse(rawValue);
          if (!Array.isArray(parsed)) return new Set();
          return new Set(
            parsed.filter((value) => Number.isInteger(value) && validCaseIds.has(value)),
          );
        } catch {
          return new Set();
        }
      };

      let completedCaseIds = loadProgress();
      /** @type {QuizCase | null} */
      let selectedCase = null;
      /** @type {number | null} */
      let confettiIntervalId = null;

      const saveProgress = () => {
        try {
          window.localStorage.setItem(
            progressStorageKey,
            JSON.stringify(Array.from(completedCaseIds)),
          );
        } catch {
          return;
        }
      };

      /** @param {number} caseId */
      const isCaseCompleted = (caseId) => completedCaseIds.has(caseId);

      /** @param {number} caseId */
      const markCaseAsCompleted = (caseId) => {
        if (isCaseCompleted(caseId)) return false;
        completedCaseIds.add(caseId);
        saveProgress();
        return true;
      };

      const clearProgress = () => {
        completedCaseIds = new Set();
        try {
          window.localStorage.removeItem(progressStorageKey);
        } catch {
          return;
        }
      };

      /** @param {string | number} value */
      const escapeHTML = (value) =>
        String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");

      const launchConfetti = () => {
        const animationDuration = 3000;
        const animationEnd = Date.now() + animationDuration;

        if (confettiIntervalId) {
          window.clearInterval(confettiIntervalId);
          confettiIntervalId = null;
        }

        const fireRandomBurst = () => {
          confetti({
            particleCount: Math.floor(30 + Math.random() * 35),
            spread: Math.floor(70 + Math.random() * 60),
            startVelocity: Math.floor(30 + Math.random() * 20),
            ticks: 120,
            origin: {
              x: Math.random(),
              y: Math.max(0, Math.random() - 0.2),
            },
          });
        };

        fireRandomBurst();

        confettiIntervalId = window.setInterval(() => {
          if (Date.now() > animationEnd) {
            if (confettiIntervalId) {
              window.clearInterval(confettiIntervalId);
              confettiIntervalId = null;
            }
            return;
          }
          fireRandomBurst();
        }, 220);
      };

      /** @param {number} caseId */
      const applyCaseCompletedStyles = (caseId) => {
        const isCompleted = isCaseCompleted(caseId);

        patientAside?.classList.toggle("from-blue-light-metoject/20", !isCompleted);
        patientAside?.classList.toggle("to-blue-dark-metoject/10", !isCompleted);
        patientAside?.classList.toggle("from-gold-light-metoject/20", isCompleted);
        patientAside?.classList.toggle("to-gold-dark-metoject/20", isCompleted);

        patientInfoCard?.classList.toggle("bg-blue-dark-metoject", !isCompleted);
        patientInfoCard?.classList.toggle("text-white", !isCompleted);
        patientInfoCard?.classList.toggle("bg-gold-dark-metoject", isCompleted);
        patientInfoCard?.classList.toggle("text-slate-900", isCompleted);
      };

      const hideFeedback = () => {
        if (!feedbackModal || !feedbackCard || !feedbackText || !feedbackTitle || !feedbackIcon)
          return;
        feedbackModal.classList.add("hidden");
        feedbackModal.classList.remove("flex");
        feedbackCard.classList.remove(
          "border-gold-dark-metoject",
          "bg-linear-to-r",
          "from-gold-dark-metoject",
          "via-gold-light-metoject",
          "to-gold-dark-metoject",
          "text-slate-900",
          "border-blue-light-metoject",
          "from-blue-dark-metoject",
          "via-blue-light-metoject",
          "to-blue-dark-metoject",
          "text-white",
        );
        feedbackTitle.classList.remove("hidden");
        feedbackIcon.removeAttribute("src");
        feedbackIcon.setAttribute("alt", "");
        feedbackTitle.textContent = "";
        feedbackText.textContent = "";
      };

      /** @param {boolean} isCorrect @param {string} message */
      const showFeedback = (isCorrect, message) => {
        if (!feedbackModal || !feedbackCard || !feedbackText || !feedbackTitle || !feedbackIcon)
          return;

        feedbackModal.classList.remove("hidden");
        feedbackModal.classList.add("flex");
        feedbackCard.classList.add("bg-linear-to-r");
        feedbackCard.classList.toggle("border-gold-dark-metoject", isCorrect);
        feedbackCard.classList.toggle("from-gold-dark-metoject", isCorrect);
        feedbackCard.classList.toggle("via-gold-light-metoject", isCorrect);
        feedbackCard.classList.toggle("to-gold-dark-metoject", isCorrect);
        feedbackCard.classList.toggle("text-slate-900", isCorrect);
        feedbackCard.classList.toggle("border-blue-light-metoject", !isCorrect);
        feedbackCard.classList.toggle("from-blue-dark-metoject", !isCorrect);
        feedbackCard.classList.toggle("via-blue-light-metoject", !isCorrect);
        feedbackCard.classList.toggle("to-blue-dark-metoject", !isCorrect);
        feedbackCard.classList.toggle("text-white", !isCorrect);

        feedbackIcon.setAttribute(
          "src",
          `${urlBase}/imgs/svg/${isCorrect ? "check.svg" : "x.svg"}`,
        );
        feedbackIcon.setAttribute(
          "alt",
          isCorrect ? "Respuesta correcta" : "Respuesta incorrecta",
        );

        if (isCorrect) {
          feedbackTitle.classList.add("hidden");
          feedbackTitle.textContent = "";
        } else {
          feedbackTitle.classList.remove("hidden");
          feedbackTitle.textContent = "¡Intenta de nuevo!";
        }

        feedbackText.textContent = message;
      };

      /** @param {number} caseId */
      const selectCase = (caseId) => {
        selectedCase = cases.find((item) => item.id === caseId) || null;
        if (!selectedCase) return;

        hideFeedback();

        if (caseTitle) caseTitle.textContent = selectedCase.title;
        if (caseDescription)
          caseDescription.textContent = selectedCase.description;
        if (caseQuestion) caseQuestion.textContent = selectedCase.question;

        if (caseBadge) {
          caseBadge.setAttribute(
            "src",
            `${urlBase}/imgs/insignias/${selectedCase.badgeUrl}`,
          );
          caseBadge.setAttribute("alt", `Insignia ${selectedCase.title}`);
        }

        if (patientImage) {
          patientImage.setAttribute(
            "src",
            `${urlBase}/imgs/pacientes/${selectedCase.imageUrl}`,
          );
          patientImage.setAttribute(
            "alt",
            `Imagen de ${selectedCase.patientName}`,
          );
        }

        if (patientName) patientName.textContent = selectedCase.patientName;
        if (patientAge) patientAge.textContent = `${selectedCase.age} años`;

        applyCaseCompletedStyles(selectedCase.id);

        if (optionsList) {
          optionsList.innerHTML = selectedCase.options
            .map(
              (option, optionIndex) => `
								<li>
									<button
										type="button"
										data-option-index="${optionIndex}"
										class="quiz-option w-full rounded-xl border-2 border-blue-dark-metoject/20 bg-blue-light-metoject/10 p-3 text-left font-raleway text-slate-800 transition hover:border-blue-dark-metoject hover:bg-blue-light-metoject/20"
									>
										<span class="font-bold text-blue-dark-metoject">${String.fromCharCode(65 + optionIndex)}.</span>
										${escapeHTML(option)}
									</button>
								</li>
							`,
            )
            .join("");
        }

        if (referencesList) {
          referencesList.innerHTML = selectedCase.references
            .map((reference) => `<li>${escapeHTML(reference)}</li>`)
            .join("");
        }

        selectorView?.classList.add("hidden");
        caseView?.classList.remove("hidden");
      };

      const renderPatientSelector = () => {
        if (!patientsGrid) return;

        patientsGrid.innerHTML = cases
          .map((item) => {
            const isCompleted = isCaseCompleted(item.id);
            const selectorButtonClasses = isCompleted
              ? "group relative rounded-2xl border border-gold-dark-metoject bg-white p-3 text-left shadow transition hover:-translate-y-1 hover:shadow-lg"
              : "group relative rounded-2xl border border-blue-light-metoject/50 bg-white p-3 text-left shadow transition hover:-translate-y-1 hover:shadow-lg";
            const infoCardClasses = isCompleted
              ? "rounded-lg px-3 py-2 text-center bg-radial from-gold-light-metoject to-gold-dark-metoject text-slate-900"
              : "rounded-lg px-3 py-2 text-center bg-radial from-blue-light-metoject to-blue-dark-metoject text-white";

            return `
							<button
								type="button"
								data-case-id="${item.id}"
                class="${selectorButtonClasses}"
							>
                ${
                  isCompleted
                    ? `<span class="absolute right-2 top-2 flex h-8 w-8 items-center justify-center rounded-full bg-gold-dark-metoject shadow">
                      <img
                        src="${urlBase}/imgs/svg/check.svg"
                        alt="Paciente completado"
                        class="h-5 w-5"
                      />
                    </span>`
                    : ""
                }
								<img
									src="${urlBase}/imgs/pacientes/${item.imageUrl}"
									alt="Paciente ${escapeHTML(item.patientName)}"
									class="mx-auto h-64 w-full object-contain"
								/>
                <div class="${infoCardClasses}">
									<p class="font-raleway text-2xl font-black">${escapeHTML(item.patientName)}</p>
									<p class="font-raleway text-lg">${item.age} años</p>
								</div>
							</button>
            `;
          })
          .join("");
      };

      const handleResetProgress = () => {
        const shouldReset = window.confirm(
          "¿Deseas reiniciar el progreso? Se borrarán todos los pacientes completados.",
        );
        if (!shouldReset) return;

        clearProgress();
        hideFeedback();
        renderPatientSelector();

        if (selectedCase) {
          applyCaseCompletedStyles(selectedCase.id);
        }
      };

      app.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;

        const resetButton = target.closest('[data-action="reset-progress"]');
        if (resetButton instanceof HTMLElement) {
          handleResetProgress();
          return;
        }

        const caseButton = target.closest("[data-case-id]");
        if (caseButton instanceof HTMLElement) {
          const caseId = Number(caseButton.dataset.caseId);
          if (!Number.isNaN(caseId)) selectCase(caseId);
          return;
        }

        const optionButton = target.closest("[data-option-index]");
        if (optionButton instanceof HTMLElement && selectedCase) {
          const optionIndex = Number(optionButton.dataset.optionIndex);
          if (Number.isNaN(optionIndex)) return;

          const isCorrect = optionIndex === selectedCase.correctAnswer;
          const message = isCorrect
            ? selectedCase.correctFeedback
            : selectedCase.incorrectFeedback;

          if (isCorrect) {
            const isFirstCompletion = markCaseAsCompleted(selectedCase.id);
            if (isFirstCompletion) {
              applyCaseCompletedStyles(selectedCase.id);
              renderPatientSelector();
              launchConfetti();
            }
          }

          showFeedback(isCorrect, message);
        }
      });

      backToPatientsButton?.addEventListener("click", () => {
        hideFeedback();
        caseView?.classList.add("hidden");
        selectorView?.classList.remove("hidden");
      });

      feedbackOverlay?.addEventListener("click", hideFeedback);
      feedbackClose?.addEventListener("click", hideFeedback);

      renderPatientSelector();
    })();
  </script>
</Layout>
