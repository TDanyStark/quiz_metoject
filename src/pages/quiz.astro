---
import { URL_BASE } from "@/config";
import { quizData } from "@/data";
import Layout from "@/layouts/Layout.astro";
import Footer from "@/components/Footer.astro";
import Header from "@/components/Header.astro";
---

<Layout>
  <div
    class="relative flex min-h-screen flex-col"
    style={`background-image: url('${URL_BASE}/imgs/bg-main.webp'); background-size: cover; background-position: center;`}
  >
    <Header />

    <main class="flex flex-1 items-center justify-center p-4 md:p-6">
      <section
        id="quiz-app"
        class="w-full max-w-7xl rounded-2xl border border-blue-light-metoject/30 bg-white/80 p-4 shadow-xl backdrop-blur-sm md:p-6"
        data-url-base={URL_BASE}
      >
        <div id="selector-view" class="space-y-2">
          <h1
            class="text-center font-raleway text-4xl font-black text-blue-dark-metoject md:text-5xl"
          >
            CASOS CLÍNICOS
          </h1>
          <p class="text-center font-raleway text-blue-dark-metoject/80 text-lg">
            Selecciona un paciente para resolver su caso clínico.
          </p>
          <div
            id="patients-grid"
            class="mt-10 grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-4"
          >
          </div>
        </div>

        <div id="case-view" class="hidden space-y-4">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <button
              id="back-to-patients"
              type="button"
              class="rounded-lg bg-blue-dark-metoject px-4 py-2 font-raleway text-sm font-bold text-white transition hover:opacity-90"
            >
              Cambiar paciente
            </button>
            <div class="flex items-center gap-3">
              <h2
                id="case-title"
                class="font-raleway text-2xl font-black text-blue-dark-metoject"
              >
              </h2>
              <img
                id="case-badge"
                class="h-20 lg:h-36 w-auto"
                alt="Insignia del caso"
              />
            </div>
          </div>

          <div class="grid grid-cols-1 gap-4 lg:grid-cols-[1fr_400px]">
            <article class="relative rounded-2xl bg-white p-5 shadow-lg">
              <p
                id="case-description"
                class="mb-4 font-raleway text-pretty leading-relaxed text-slate-700 md:text-lg"
              >
              </p>
              <h3
                id="case-question"
                class="mb-4 font-raleway text-pretty text-xl font-bold text-blue-dark-metoject"
              >
              </h3>

              <ul id="options-list" class="space-y-3"></ul>

              <div
                id="feedback-modal"
                class="fixed inset-0 z-50 hidden items-center justify-center"
                role="dialog"
                aria-modal="true"
                aria-live="polite"
              >
                <button
                  type="button"
                  id="feedback-overlay"
                  aria-label="Cerrar notificación"
                  class="absolute inset-0 bg-slate-900/35 rounded-2xl"
                ></button>

                <div
                  id="feedback-card"
                  class="relative mx-4 w-full max-w-3xl rounded-4xl border-2 p-7 md:p-10"
                >
                  <button
                    type="button"
                    id="feedback-close"
                    aria-label="Cerrar"
                    class="absolute right-4 top-4 flex h-9 w-9 items-center justify-center rounded-full border-2 border-current text-xl font-bold leading-none transition hover:opacity-90"
                  >
                    ×
                  </button>

                  <div class="mx-auto max-w-2xl text-center">
                    <img
                      id="feedback-icon"
                      class="mx-auto mb-3 h-16 w-16 md:h-20 md:w-20"
                      alt=""
                    />
                    <p
                      id="feedback-title"
                      class="mb-2 font-raleway text-4xl font-black leading-tight md:text-5xl"
                    >
                    </p>
                    <p
                      id="feedback-text"
                      class="font-raleway text-base font-bold leading-snug md:text-2xl"
                    >
                    </p>
                  </div>
                </div>
              </div>

              <div class="mt-5 border-t border-slate-200 pt-4">
                <h4
                  class="mb-2 font-raleway text-sm font-bold text-blue-dark-metoject"
                >
                  Referencias
                </h4>
                <ol
                  id="references-list"
                  class="list-decimal space-y-1 pl-5 font-raleway text-xs text-slate-600 md:text-sm"
                >
                </ol>
              </div>
            </article>

            <aside
              class="flex flex-col justify-end rounded-2xl bg-linear-to-b from-blue-light-metoject/20 to-blue-dark-metoject/10 p-3"
            >
              <img
                id="patient-image"
                class="mx-auto h-auto w-full max-w-96"
                alt="Paciente"
              />
              <div
                class="rounded-xl bg-blue-dark-metoject p-3 text-center text-white"
              >
                <p class="font-raleway text-2xl font-black" id="patient-name">
                </p>
                <p class="font-raleway text-base" id="patient-age"></p>
              </div>
            </aside>
          </div>
        </div>
      </section>
    </main>

    <Footer/>
  </div>

  <script is:inline define:vars={{ quizData }}>
    (() => {
      const app = document.getElementById("quiz-app");
      if (!app) return;

      const cases = Array.isArray(quizData?.cases) ? quizData.cases : [];
      const urlBase = app.dataset.urlBase || "";

      const selectorView = document.getElementById("selector-view");
      const caseView = document.getElementById("case-view");
      const patientsGrid = document.getElementById("patients-grid");
      const backToPatientsButton = document.getElementById("back-to-patients");

      const caseBadge = document.getElementById("case-badge");
      const caseTitle = document.getElementById("case-title");
      const caseDescription = document.getElementById("case-description");
      const caseQuestion = document.getElementById("case-question");
      const optionsList = document.getElementById("options-list");
      const referencesList = document.getElementById("references-list");

      const patientImage = document.getElementById("patient-image");
      const patientName = document.getElementById("patient-name");
      const patientAge = document.getElementById("patient-age");

      const feedbackModal = document.getElementById("feedback-modal");
      const feedbackOverlay = document.getElementById("feedback-overlay");
      const feedbackCard = document.getElementById("feedback-card");
      const feedbackClose = document.getElementById("feedback-close");
      const feedbackIcon = document.getElementById("feedback-icon");
      const feedbackTitle = document.getElementById("feedback-title");
      const feedbackText = document.getElementById("feedback-text");

      let selectedCase = null;

      const escapeHTML = (value) =>
        String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");

      const hideFeedback = () => {
        if (!feedbackModal || !feedbackCard || !feedbackText || !feedbackTitle || !feedbackIcon)
          return;
        feedbackModal.classList.add("hidden");
        feedbackModal.classList.remove("flex");
        feedbackCard.classList.remove(
          "border-gold-dark-metoject",
          "bg-linear-to-r",
          "from-gold-dark-metoject",
          "via-gold-light-metoject",
          "to-gold-dark-metoject",
          "text-slate-900",
          "border-blue-light-metoject",
          "from-blue-dark-metoject",
          "via-blue-light-metoject",
          "to-blue-dark-metoject",
          "text-white",
        );
        feedbackTitle.classList.remove("hidden");
        feedbackIcon.removeAttribute("src");
        feedbackIcon.setAttribute("alt", "");
        feedbackTitle.textContent = "";
        feedbackText.textContent = "";
      };

      const showFeedback = (isCorrect, message) => {
        if (!feedbackModal || !feedbackCard || !feedbackText || !feedbackTitle || !feedbackIcon)
          return;

        feedbackModal.classList.remove("hidden");
        feedbackModal.classList.add("flex");
        feedbackCard.classList.add("bg-linear-to-r");
        feedbackCard.classList.toggle("border-gold-dark-metoject", isCorrect);
        feedbackCard.classList.toggle("from-gold-dark-metoject", isCorrect);
        feedbackCard.classList.toggle("via-gold-light-metoject", isCorrect);
        feedbackCard.classList.toggle("to-gold-dark-metoject", isCorrect);
        feedbackCard.classList.toggle("text-slate-900", isCorrect);
        feedbackCard.classList.toggle("border-blue-light-metoject", !isCorrect);
        feedbackCard.classList.toggle("from-blue-dark-metoject", !isCorrect);
        feedbackCard.classList.toggle("via-blue-light-metoject", !isCorrect);
        feedbackCard.classList.toggle("to-blue-dark-metoject", !isCorrect);
        feedbackCard.classList.toggle("text-white", !isCorrect);

        feedbackIcon.setAttribute(
          "src",
          `${urlBase}/imgs/svg/${isCorrect ? "check.svg" : "x.svg"}`,
        );
        feedbackIcon.setAttribute(
          "alt",
          isCorrect ? "Respuesta correcta" : "Respuesta incorrecta",
        );

        if (isCorrect) {
          feedbackTitle.classList.add("hidden");
          feedbackTitle.textContent = "";
        } else {
          feedbackTitle.classList.remove("hidden");
          feedbackTitle.textContent = "¡Intenta de nuevo!";
        }

        feedbackText.textContent = message;
      };

      const selectCase = (caseId) => {
        selectedCase = cases.find((item) => item.id === caseId) || null;
        if (!selectedCase) return;

        hideFeedback();

        if (caseTitle) caseTitle.textContent = selectedCase.title;
        if (caseDescription)
          caseDescription.textContent = selectedCase.description;
        if (caseQuestion) caseQuestion.textContent = selectedCase.question;

        if (caseBadge) {
          caseBadge.setAttribute(
            "src",
            `${urlBase}/imgs/insignias/${selectedCase.badgeUrl}`,
          );
          caseBadge.setAttribute("alt", `Insignia ${selectedCase.title}`);
        }

        if (patientImage) {
          patientImage.setAttribute(
            "src",
            `${urlBase}/imgs/pacientes/${selectedCase.imageUrl}`,
          );
          patientImage.setAttribute(
            "alt",
            `Imagen de ${selectedCase.patientName}`,
          );
        }

        if (patientName) patientName.textContent = selectedCase.patientName;
        if (patientAge) patientAge.textContent = `${selectedCase.age} años`;

        if (optionsList) {
          optionsList.innerHTML = selectedCase.options
            .map(
              (option, optionIndex) => `
								<li>
									<button
										type="button"
										data-option-index="${optionIndex}"
										class="quiz-option w-full rounded-xl border-2 border-blue-dark-metoject/20 bg-blue-light-metoject/10 p-3 text-left font-raleway text-slate-800 transition hover:border-blue-dark-metoject hover:bg-blue-light-metoject/20"
									>
										<span class="font-bold text-blue-dark-metoject">${String.fromCharCode(65 + optionIndex)}.</span>
										${escapeHTML(option)}
									</button>
								</li>
							`,
            )
            .join("");
        }

        if (referencesList) {
          referencesList.innerHTML = selectedCase.references
            .map((reference) => `<li>${escapeHTML(reference)}</li>`)
            .join("");
        }

        selectorView?.classList.add("hidden");
        caseView?.classList.remove("hidden");
      };

      const renderPatientSelector = () => {
        if (!patientsGrid) return;

        patientsGrid.innerHTML = cases
          .map(
            (item) => `
							<button
								type="button"
								data-case-id="${item.id}"
								class="group rounded-2xl border border-blue-light-metoject/50 bg-white p-3 text-left shadow transition hover:-translate-y-1 hover:shadow-lg"
							>
								<img
									src="${urlBase}/imgs/pacientes/${item.imageUrl}"
									alt="Paciente ${escapeHTML(item.patientName)}"
									class="mx-auto h-64 w-full object-contain"
								/>
								<div class="rounded-lg bg-blue-dark-metoject px-3 py-2 text-white text-center bg-radial from-blue-light-metoject to-blue-dark-metoject ">
									<p class="font-raleway text-2xl font-black">${escapeHTML(item.patientName)}</p>
									<p class="font-raleway text-lg">${item.age} años</p>
								</div>
							</button>
						`,
          )
          .join("");
      };

      app.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;

        const caseButton = target.closest("[data-case-id]");
        if (caseButton instanceof HTMLElement) {
          const caseId = Number(caseButton.dataset.caseId);
          if (!Number.isNaN(caseId)) selectCase(caseId);
          return;
        }

        const optionButton = target.closest("[data-option-index]");
        if (optionButton instanceof HTMLElement && selectedCase) {
          const optionIndex = Number(optionButton.dataset.optionIndex);
          if (Number.isNaN(optionIndex)) return;

          const isCorrect = optionIndex === selectedCase.correctAnswer;
          const message = isCorrect
            ? selectedCase.correctFeedback
            : selectedCase.incorrectFeedback;
          showFeedback(isCorrect, message);
        }
      });

      backToPatientsButton?.addEventListener("click", () => {
        hideFeedback();
        caseView?.classList.add("hidden");
        selectorView?.classList.remove("hidden");
      });

      feedbackOverlay?.addEventListener("click", hideFeedback);
      feedbackClose?.addEventListener("click", hideFeedback);

      renderPatientSelector();
    })();
  </script>
</Layout>
